<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sorteny_model.h - SORTENY Encoder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="../../../styles.css">
</head>
<body class="code-page">
    <div class="header">
        <h1>üìÑ sorteny_model.h</h1>
        <a href="../../../index.html">‚Üê Tornar a l'√≠ndex</a>
    </div>
    <div class="file-info">
        <strong>Ruta:</strong> src/c/sorteny_model.h &nbsp;|&nbsp;
        <strong>Descripci√≥:</strong> Header amb les definicions d'estructures de dades per al model SORTENY (ConvLayer, GDNLayer, DenseLayer, etc.).
    </div>
    <div class="code-container">
        <pre><code class="language-c">#ifndef SORTENY_MODEL_H
#define SORTENY_MODEL_H

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdint.h&gt;

#ifdef __cplusplus
extern "C" {
#endif


// --- ESTRUCTURAS DE DATOS PARA LOS PESOS --- 

// Estructura gen√©rica para una capa Convolucional
typedef struct {
    float* kernel; // Forma: [kH, kW, C_in, C_out]
    float* bias;   // Forma: [C_out] o NULL si la capa no tiene bias
    
    // Dimensiones (para saber c√≥mo leer los kernels)
    size_t kH, kW, C_in, C_out;

    // Paso de la convoluci√≥n (strides_down del modelo Keras)
    int stride; // t√≠picamente 1 o 2

    // Indicador de si existe bias
    int has_bias; // 1 si hay bias, 0 si no
    
} ConvLayer;

// Estructura para una capa GDN
typedef struct {
    float* beta;   // Forma: [C]
    float* gamma;  // Forma: [C, C]
    size_t C;
    float epsilon; // peque√±a constante para evitar divisi√≥n por cero
} GDNLayer;

// Estructura para una capa Densa (Multiplicaci√≥n de Matriz)
typedef struct {
    float* kernel; // Forma: [C_in, C_out]
    float* bias;   // Forma: [C_out]
    size_t C_in, C_out;
} DenseLayer;

// 1. Transformada Espectral
typedef struct {
    DenseLayer dense; // 8x8
} SpectralTransform;

// 2. Transformada de An√°lisis
typedef struct {
    // [Lambda], Conv, Conv, Conv, Conv
    ConvLayer conv_0;
    GDNLayer  gdn_0;
    ConvLayer conv_1;
    GDNLayer  gdn_1;
    ConvLayer conv_2;
    GDNLayer  gdn_2;
    ConvLayer conv_3; // Esta no tiene ni bias ni GDN
} AnalysisTransform;

// 3. Transformada de Modulaci√≥n
typedef struct {
    // [Lambda], Dense, Dense
    DenseLayer dense_0;
    DenseLayer dense_1;
} ModulatingTransform;


// --- ESTRUCTURA PRINCIPAL DEL MODELO ---
typedef struct {
    SpectralTransform      spectral_an;
    AnalysisTransform      analysis_an;
    ModulatingTransform    modulating_mod;
    
} SORTENY_Model;


// --- DECLARACI√ìN DE FUNCIONES ---

/**
 * @brief Carga todos los pesos del modelo desde la carpeta 'pesos_bin/'.
 * @param base_path Ruta a la carpeta 'pesos_bin/'.
 * @return Un puntero al modelo cargado, o NULL si falla.
 */
SORTENY_Model* load_model_weights(const char* base_path);

/**
 * @brief Libera toda la memoria (free) reservada por load_model_weights.
 */
void free_model_weights(SORTENY_Model* model);

/**
 * @brief Aplica la transformada espectral (Etapa 1).
 */
void apply_spectral_analysis(float* restrict out_tensor, const float* restrict in_tensor, 
                             const SpectralTransform* tf, int H, int W);

/**
 * @brief Aplica una convoluci√≥n 2D (Etapa 2 y 4).
 */
void apply_conv2d(float* restrict out_tensor, const float* restrict in_tensor, 
                  const ConvLayer* layer, int H_in, int W_in);

/**
 * @brief Aplica la activaci√≥n GDN (Etapa 2).
 */
void apply_gdn(float* restrict out_tensor, const float* restrict in_tensor,
               const GDNLayer* layer, int H, int W);

/**
 * @brief Aplica una capa Densa (Etapa 1 y 3).
 */
void apply_dense(float* restrict out_tensor, const float* restrict in_tensor, 
                 const DenseLayer* layer);

/**
 * @brief Aplica la activaci√≥n ReLU.
 */
void apply_relu(float* restrict tensor, int size);


#ifdef __cplusplus
}
#endif

#endif // SORTENY_MODEL_H</code></pre>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>
